@page "/{ViewRoute}/edit/{Rowid}"
@using Appointment.Globals.Enums

@inherits DynamicBaseView

<PageTitle>Editar @Module.SingularName</PageTitle>

@if(ViewIsReady && RouteIsValid && Entity is not null)
{
    <h3>Editar @Module.SingularName</h3>

    <RadzenStack Orientation="@Orientation.Horizontal" JustifyContent="@JustifyContent.End">
        <RadzenButton Disabled="@IsBusy" Click="NavigateToList" Variant="Variant.Flat" Text="Cancelar" ButtonStyle="ButtonStyle.Warning" />
        <RadzenButton form="@FormId" ButtonType="ButtonType.Submit" Variant="Variant.Flat" Text="Guardar" ButtonStyle="ButtonStyle.Primary" IsBusy=@IsBusy />
    </RadzenStack>

    <EditForm id="@FormId" 
        OnValidSubmit="@HandleValidSubmit"
        OnInvalidSubmit="@HandleInvalidSubmit" 
        EditContext="@EditFormContext">

        <CascadingValue Value="@this">
            @Module.GetForm(ViewType.Create)
        </CascadingValue>

    </EditForm>
}else if(ViewIsReady && !RouteIsValid)
{
    <p>Ruta inv√°lida</p>
}
else
{
    <p>Cargando...</p>
}

@code
{
    protected override void OnInitialized()
    {
        _ = InitView();

        base.OnInitialized();
    }

    private async Task InitView()
    {
        ViewIsReady = true;
        LastViewRoute = ViewRoute;
        RouteIsValid = ApiService.EndPointIsSaved(ViewRoute);

        if(RouteIsValid)
        {
            SearchModule();
        }else
        {
            return;
        }

        SetEditForm();
        await Module.GetItem(Rowid);

        SetEntity();

        StateHasChanged();
    }

    protected override void OnParametersSet()
    {
        if(ViewRoute != LastViewRoute)
        {
            _ = InitView();
            StateHasChanged();
        }

        base.OnParametersSet();
    }
}